---
title: "R Notebook"
output: html_notebook
---

## Project Description

## Why did we choose this project?


## Data
The dataset ... too include(Brazil, state of Espirito Santo - Public Sector - Primary Care)
*Description of the dataset*
- Age: Age of the patient
- Gender: Gender of the patient
- AppointmentRegistration: Time and date when the patient took the appointment
- AppointmentData: Date of the appointment
- Diabetes: Is the patient affected by diabetes? (0/1)
- Alcoolism: is the patient alcoolic? (0/1)
- Hipertension: Is the patient affected by hypertension? (0/1)
- Handcap: 
- Smokes: Is the patient smoking? (0/1)
- Scholarship: Is the patient receiving a scholarship? Those scholarships are given by Bolsa Familia to low income families who accept to send their kids to school nd have them vaccinated. 
- Tuberculosis: Is the patient affected by tuberculosis? (0/1)
- AwaitingTime: How many days the patient waited between the appointment registration and the date of the appointment
- Status: Did the patient show-up or not? (No-Show/Show-Up)
*Source*

## Data formating

**Step 0: Load Packages**

```{r}
library(plyr)
library(dplyr)
library(ggplot2)
```

**Step 1: Load Dataset**
```{r}
dataset <- read.csv("../data/No-show-Issue-Comma-300k.csv")
```

**Step 2: Clean & Organize dataset**
```{r}
# Check Format
str(dataset)
```

```{r}
# Update Columns Names
colnames(dataset) <- c("age", "gender", "appointment_registration", 
                       "appointment_date", "dayofweek_apptmt", "show_up",
                       "diabetes", "alcoholism", "hypertension", "handicap", 
                       "smoker", "scholarship", "tuberculosis",
                       "sms_reminder", "daydiff_regist_appt")

# Update Columns Format
dataset$sms_reminder <- factor(dataset$sms_reminder)
dataset$diabetes <- factor(dataset$diabetes)
dataset$alcoholism <- factor(dataset$alcoholism)
dataset$hypertension <- factor(dataset$hypertension)
dataset$handicap <- factor(dataset$handicap)
dataset$smoker <- factor(dataset$smoker)
dataset$scholarship <- factor(dataset$scholarship)
dataset$tuberculosis <- factor(dataset$tuberculosis)
```

```{r}
# Check Values
summary(dataset)
```


```{r}
# Data Cleaning

# Age: The Age shouldn't be negative, we will remove those rows. 
dataset <- dataset[dataset$age>0,]

# Appointment day of the week: We don't know if this variable is linked to the registration date or the apointment date - we will delete it and use the raw columns only
dataset$dayofweek_apptmt <- NULL

# Number of days between registration time and appointment date: We will convert this value to be positive
dataset$daydiff_regist_appt <- -(dataset$daydiff_regist_appt)

# Show-up / No-Show: 
dataset$show_up <- revalue(dataset$show_up, c("No-Show"=0, "Show-Up"=1))

# clean dates and time:
## Appt Registration Date
dataset$appointment_registration <- as.POSIXct(as.character(dataset$appointment_registration), 
                                               "%Y-%m-%d T%H:%M:%SZ", 
                                               tz ="Brazil/East")

dataset$weekday_registration <- as.factor(format(dataset$appointment_registration, "%a"))
dataset$day_registration <- as.numeric(as.integer(format(dataset$appointment_registration, 
                                                         "%d")))
dataset$month_registration <- as.numeric(format(dataset$appointment_registration, "%m"))
dataset$hour_registration <- as.numeric(format(dataset$appointment_registration,"%H"))
dataset$minute_registration <- as.numeric(format(dataset$appointment_registration,"%M"))
dataset$day_of_year_registration <- as.numeric(format(dataset$appointment_registration,"%j"))
dataset$week_of_year_registration <- as.numeric(format(dataset$appointment_registration,"%U"))
dataset$am_pm_registration <- as.factor(format(dataset$appointment_registration,"%p"))

#Appt Actual Date
dataset$appointment_date <- as.POSIXct(as.character(dataset$appointment_date), 
                                       "%Y-%m-%d T%H:%M:%SZ", 
                                       tz = "Brazil/East")

dataset$weekday_appointment <- as.factor(format(dataset$appointment_date,"%a"))
dataset$day_appointment <- as.numeric(as.integer(format(dataset$appointment_date,"%d")))
dataset$month_appointment <- as.numeric(format(dataset$appointment_date,"%m"))
dataset$day_of_year_appointment <- as.numeric(format(dataset$appointment_date,"%j"))
dataset$week_of_year_appointment <- as.numeric(format(dataset$appointment_date,"%U"))
```

## Exploratory Data Analysis

```{r}
qplot(day_of_year_registration, data = dataset, col = show_up)
```

```{r}
qplot(day_registration, data = dataset, col = show_up)
```

```{r}
qplot(day_appointment, data = dataset, col = show_up)
```

```{r}
qplot(week_of_year_appointment, data = dataset, col = show_up)
```

```{r}
qplot(gender, data = dataset, col = show_up)
```
```{r}
summary(dataset$show_up)
```


```{r}
qplot(age, data = dataset, col = show_up)
```

```{r}
qplot(sms_reminder, data = dataset, col = show_up)
```

```{r}
g = ggplot(data = dataset, aes(x = age, color = show_up)) + geom_bar() + facet_wrap(~gender)
g
```

SHOW NOSHOW RATIO
```{r}
by_day_of_week = group_by(dataset, weekday_appointment)
by_day = summarise(by_day_of_week, show = sum(show_up == 1), noshow = sum(show_up == 0))
by_day$ratio = by_day$noshow / (by_day$show+ by_day$noshow)
by_day$weekday_appointment = relevel(by_day$weekday_appointment, "Sun")
by_day$weekday_appointment = relevel(by_day$weekday_appointment, "Sat")
by_day$weekday_appointment = relevel(by_day$weekday_appointment, "Fri")
by_day$weekday_appointment = relevel(by_day$weekday_appointment, "Thu")
by_day$weekday_appointment = relevel(by_day$weekday_appointment, "Wed")
by_day$weekday_appointment = relevel(by_day$weekday_appointment, "Tue")
by_day$weekday_appointment = relevel(by_day$weekday_appointment, "Mon")
qplot(weekday_appointment, ratio, data = by_day , geom = c("boxplot"))
```

```{r}
by_day_of_year = group_by(dataset, day_of_year_appointment)
by_day = summarise(by_day_of_year, show = sum(show_up==1), noshow = sum(show_up == 0))
by_day$ratio = by_day$noshow / (by_day$show+ by_day$noshow)

g = ggplot(data = by_day, aes(x = day_of_year_appointment, y = ratio)) + geom_line()
g
```

```{r}
by_hour = group_by(dataset, hour_registration)
by_hour = summarise(by_hour, show = sum(show_up==1), noshow = sum(show_up == 0))
by_hour$ratio = by_hour$noshow / (by_hour$show+ by_hour$noshow)

g = ggplot(data = by_hour, aes(x = hour_registration, y = ratio)) + geom_step()
g
```

```{r}
by_age = group_by(dataset, age)
by_age = summarise(by_age, show = sum(show_up==1), noshow = sum(show_up == 0))
by_age$ratio = by_age$noshow / (by_age$show+by_age$noshow)

g = ggplot(data = by_age, aes(x = age, y = ratio)) + geom_line() + geom_smooth(method = "glm")
g
```

```{r}
by_age = group_by(dataset, age)
by_age = summarise(by_age, show = sum(as.numeric(show_up)), noshow = sum(show_up == 0))
by_age$ratio = by_age$noshow / by_age$show

g = ggplot(data = by_age, aes(x = age, y = ratio)) + geom_step()
g
```


```{r}
by_age = group_by(dataset, age)
by_age = summarise(by_age, show = sum(as.numeric(show_up)), noshow = sum(show_up == 0))
by_age$ratio = by_age$noshow / by_age$show
df = data.frame(x=rep(by_age$age,2), y=c(by_age$show, by_age$noshow), class=c(rep("show", length(by_age$age)), rep("noshow", length(by_age$age))))

ggplot(df, aes(x=x, y=y, color=class)) + geom_line()
```


```{r}
g = ggplot(data = dataset, aes(x = show_up, y = age), col = show_up) + geom_violin(scale = "count") 
g
```

```{r}
g = ggplot(data = dataset, aes(x = show_up, y = age), col = show_up) + geom_violin(scale = "count") 
g
```

```{r}
by_diff = group_by(dataset, daydiff_regist_appt)
by_diff = summarise(by_diff, show = sum(as.numeric(show_up)), noshow = sum(show_up == 0))
by_diff$ratio = by_diff$noshow / by_diff$show

g = ggplot(data = by_diff, aes(x = daydiff_regist_appt, y = ratio)) + geom_line() 
g
```

```{r}
by_diff = group_by(dataset, daydiff_regist_appt)
by_diff = summarise(by_diff, show = sum(show_up==1), noshow = sum(show_up == 0))
by_diff$ratio = by_diff$noshow / (by_diff$show+by_diff$noshow)
by_diff$daydiff_regist_appt_squared = by_diff$daydiff_regist_appt**2

g = ggplot(data = by_diff[by_diff$daydiff_regist_appt<120,], aes(x = daydiff_regist_appt, y = ratio)) + geom_line() + geom_smooth(method = "loess")
g


lm(ratio~daydiff_regist_appt + daydiff_regist_appt_squared, by_diff[by_diff$daydiff_regist_appt<120,])
```


```{r}
print(sum(dataset$show_up==0)/dim(dataset)[1])
by_smoker = group_by(dataset, smoker)
by_smoker = summarise(by_smoker, show = sum(show_up==1), noshow = sum(show_up == 0))
by_smoker$ratio = by_smoker$noshow / (by_smoker$show+by_smoker$noshow)
by_smoker
```

```{r}
summary(dataset)
```




```{r}
by_diff = group_by(dataset, scholarship)
by_diff = summarise(by_diff, show = sum(show_up==1), noshow = sum(show_up == 0))
by_diff$ratio = by_diff$noshow / (by_diff$show+by_diff$noshow)

by_diff
```







