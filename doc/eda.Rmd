---
title: "R Notebook"
output: html_notebook
---

## Project Description

## Why did we choose this project?


## Dataset Description
The dataset ... too include(Brazil, state of Espirito Santo - Public Sector - Primary Care)
*Description of the dataset*
- Age: Age of the patient
- Gender: Gender of the patient
- AppointmentRegistration: Time and date when the patient took the appointment
- AppointmentData: Date of the appointment
- Diabetes: Is the patient affected by diabetes? (0/1)
- Alcoolism: is the patient alcoolic? (0/1)
- Hipertension: Is the patient affected by hypertension? (0/1)
- Handcap: 
- Smokes: Is the patient smoking? (0/1)
- Scholarship: Is the patient receiving a scholarship? Those scholarships are given by Bolsa Familia to low income families who accept to send their kids to school nd have them vaccinated. 
- Tuberculosis: Is the patient affected by tuberculosis? (0/1)
- AwaitingTime: How many days the patient waited between the appointment registration and the date of the appointment
- Status: Did the patient show-up or not? (No-Show/Show-Up)
*Source*

## Data Cleaning

**Step 0: Load Packages**

```{r}
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape2)
library(tidyr)
```

**Step 1: Load Dataset**
```{r}
dataset <- read.csv("../data/No-show-Issue-Comma-300k.csv")
```

**Step 2: Clean & Organize Dataset**
```{r}
# Check Format
str(dataset)
```

```{r}
# Update Columns Names
colnames(dataset) <- c("age", "gender", "appointment_registration", 
                       "appointment_date", "dayofweek_apptmt", "show_up",
                       "diabetes", "alcoholism", "hypertension", "handicap", 
                       "smoker", "scholarship", "tuberculosis",
                       "sms_reminder", "daydiff_regist_appt")

# Update Columns Format
dataset$sms_reminder <- factor(dataset$sms_reminder)
dataset$diabetes <- factor(dataset$diabetes)
dataset$alcoholism <- factor(dataset$alcoholism)
dataset$hypertension <- factor(dataset$hypertension)
dataset$handicap <- factor(dataset$handicap)
dataset$smoker <- factor(dataset$smoker)
dataset$scholarship <- factor(dataset$scholarship)
dataset$tuberculosis <- factor(dataset$tuberculosis)
```

```{r}
# Check Values
summary(dataset)
```

```{r}
# Data Cleaning

# Age: The Age shouldn't be negative, we will remove those rows. 
dataset <- dataset[dataset$age>0,]

# Appointment day of the week: We don't know if this variable is linked to the registration date or the apointment date - we will delete it and use the raw columns only
dataset$dayofweek_apptmt <- NULL

# Number of days between registration time and appointment date: We will convert this value to be positive
dataset$daydiff_regist_appt <- -(dataset$daydiff_regist_appt)

# Show-up / No-Show: 
dataset$show_up <- revalue(dataset$show_up, c("No-Show"=0, "Show-Up"=1))

# clean dates and time:
## Appt Registration Date
dataset$appointment_registration <- as.POSIXct(as.character(dataset$appointment_registration), 
                                               "%Y-%m-%d T%H:%M:%SZ", 
                                               tz ="Brazil/East")

dataset$weekday_registration <- as.factor(format(dataset$appointment_registration, "%a"))
dataset$day_registration <- as.numeric(as.integer(format(dataset$appointment_registration, 
                                                         "%d")))
dataset$month_registration <- as.numeric(format(dataset$appointment_registration, "%m"))
dataset$hour_registration <- as.numeric(format(dataset$appointment_registration,"%H"))
dataset$minute_registration <- as.numeric(format(dataset$appointment_registration,"%M"))
dataset$day_of_year_registration <- as.numeric(format(dataset$appointment_registration,"%j"))
dataset$week_of_year_registration <- as.numeric(format(dataset$appointment_registration,"%U"))
dataset$am_pm_registration <- as.factor(format(dataset$appointment_registration,"%p"))

#Appt Actual Date
dataset$appointment_date <- as.POSIXct(as.character(dataset$appointment_date), 
                                       "%Y-%m-%d T%H:%M:%SZ", 
                                       tz = "Brazil/East")

dataset$weekday_appointment <- as.factor(format(dataset$appointment_date,"%a"))
dataset$day_appointment <- as.numeric(as.integer(format(dataset$appointment_date,"%d")))
dataset$month_appointment <- as.numeric(format(dataset$appointment_date,"%m"))
dataset$day_of_year_appointment <- as.numeric(format(dataset$appointment_date,"%j"))
dataset$week_of_year_appointment <- as.numeric(format(dataset$appointment_date,"%U"))
```

## Exploratory Data Analysis

**Number of Datapoints**
```{r}
# Number of rows
nb_rows <- nrow(dataset)
```
We have access to 300k datapoints.  

**Prediction Variable**  
Let's first analyse the prediction variable alone.  
```{r}
ggplot(dataset, aes(x = show_up, fill=show_up)) +
  geom_bar() +
  ggtitle("Number of Patients Showing Up") +
  ylab("Count") +
  xlab("Show-up") + 
  scale_fill_discrete("Show-up", labels=c("No", "Yes")) +
  scale_x_discrete(labels=c("No", "Yes"))
```
On the 300k datapoints we have, one third of them are No-Show Datapoints.   
From a data science point of view, we have unbalanced classes, we will have to deal with it when doing predictions.   

**Timeframe & Number of Datapoints per Day**
```{r}
dataset %>% 
  group_by(appointment_date) %>% 
  summarise(patients=n()) %>% 
  ggplot(aes(x=appointment_date, y=patients)) + 
    geom_point(alpha=0.3) +
    xlab("Appointment Date") +
    ylab("Number of Patients") +
    ggtitle("Number of Patients per Date") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
We have access to 2 years of data from January 2014 or December 2015. THe number of datapoints per date is around constant. Outliers are Sundays.  

**Gender Analysis**
```{r}
gender_number <- ggplot(dataset, aes(x=gender)) +
  geom_bar() +
  xlab("Gender") + 
  ylab("Count")

gender_ratio <- ggplot(dataset, aes(x=gender, fill=show_up)) + 
  geom_bar(position="fill") + 
  xlab("Gender") + 
  ylab("Ratio") +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))

grid.arrange(gender_number, gender_ratio, ncol=2, top="Gender Analysis")
```
The first insight is that women are more often going to visit a physician. However the ration of no-show/show are realyy similar. Gender doesn't seem to play an important role.  

**Age Analysis**
```{r}
dataset %>% 
  group_by(age) %>% 
  summarise(nb_perage=n()) %>% 
  ggplot(aes(x=age, y=nb_perage)) + 
    geom_point(alpha=0.3) +
    xlab("Age") +
    ylab("Number of Patients") +
    ggtitle("Number of Patients depending on the Age")
```
On the first graph, we display the number of patient depending on the age to know what the sample we have look like. After 60 years old, people begin to die, and hence there are less patients. We see on the representation of the expectited living time of people in Brazil.  

```{r}
ggplot(dataset, aes(x=show_up, y=age, fill=show_up)) + 
  geom_boxplot() +
  xlab("Age") +
  ylab("Show-up") +
  ggtitle("Number of Patients depending showing up depedning on the Age") +
  scale_fill_discrete("Show-up", labels=c("No", "Yes")) +
  scale_x_discrete(labels=c("No", "Yes"))
```
The age seems to be a important factor. The older the people are the more likely they are going to show up.  

```{r}
by_age <-
  dataset %>%
    group_by(age) %>%
    summarise(show = sum(show_up==1), noshow = sum(show_up == 0))
by_age$ratio = by_age$noshow / (by_age$show+by_age$noshow)

ggplot(data = by_age, aes(x = age, y = ratio)) + 
  geom_line() + 
  geom_smooth(method = "glm")

```
Above, we can see the same trend. After 95 years old the figures are not significant because the sample is too small.  

**Age & Gender Analysis**
```{r}
ggplot(data = dataset, aes(x = age, fill = show_up)) + 
  geom_bar() + 
  facet_wrap(~gender) +
  xlab("Age") +
  ylab("Count") +
  ggtitle("Number of Patients depending showing up depedning on the Age and Gender") +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
```
The ratio is similar between woman and man. We see again that women take more appointments. However we see that before 20 years old the numbe rof appointments and the trend is exactly the same.  

**Health Conditions Analysis**
```{r}
diabetes <- ggplot(dataset, aes(x=diabetes, fill=show_up)) + 
  geom_bar(position="fill") +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
alcoholism <- ggplot(dataset, aes(x=alcoholism, fill=show_up)) + 
  geom_bar(position="fill") +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
hypertension <- ggplot(dataset, aes(x=hypertension, fill=show_up)) + 
  geom_bar(position="fill") +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
handicap <- ggplot(dataset, aes(x=handicap, fill=show_up)) + 
  geom_bar(position="fill") +
  ylab("Ratio") +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
smoker <- ggplot(dataset, aes(x=smoker, fill=show_up)) + 
  geom_bar(position="fill") +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
tuberculosis <- ggplot(dataset, aes(x=tuberculosis, fill=show_up)) + 
  geom_bar(position="fill") +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))

grid.arrange(diabetes, tuberculosis, hypertension, handicap, smoker,
             alcoholism, ncol=2, top='Health Conditions')
```
Form this first anaysis, we can conclude that people having a handicap are more likely to show up, going further the more severe is there handicap the more likely they are going to show up. The same trand is observed for people havnig diabete or hypertension.  
However for smokers, alcoholic people and people suffering from tuberculosis, the trend is reverse.  
To validate this insights, we need to look at the samples size, which we are going to do below.  

```{r}
diabetes <- ggplot(dataset, aes(x=diabetes, fill=show_up)) + 
  geom_bar() +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
alcoholism <- ggplot(dataset, aes(x=alcoholism, fill=show_up)) + 
  geom_bar() +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
hypertension <- ggplot(dataset, aes(x=hypertension, fill=show_up)) + 
  geom_bar() +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
handicap <- ggplot(dataset, aes(x=handicap, fill=show_up)) + 
  geom_bar() +
  ylab("Ratio") +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
smoker <- ggplot(dataset, aes(x=smoker, fill=show_up)) + 
  geom_bar() +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
tuberculosis <- ggplot(dataset, aes(x=tuberculosis, fill=show_up)) + 
  geom_bar() +
  ylab("Ratio") +
  scale_x_discrete(labels=c("No", "Yes")) +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))

grid.arrange(diabetes, tuberculosis, hypertension, handicap, smoker,
             alcoholism, ncol=2, top='Health Conditions')
```
As we were expected, we always have less sick people. The number of people having tuberculosis is so low that the ratio we analyzed earlier should not to be taken into account.   

**SMS Reminder**
```{r}
smsreminder_number <- ggplot(dataset, aes(x=sms_reminder)) +
  geom_bar() +
  xlab("Sms Reminder") + 
  ylab("Count")

smsreminder_ratio <- ggplot(dataset, aes(x=sms_reminder, fill=show_up)) + 
  geom_bar(position="fill") + 
  xlab("Sms Reminder") + 
  ylab("Ratio") +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))

grid.arrange(smsreminder_number, smsreminder_ratio, ncol=2, top="Sms Reminder")
```
There is no strong pattern associated with the sending of a sms reminder. Without taking into account people that received 2 sms (too few people), we notice that the ration is really similar. However we don't know if those sms are sent randomnly or not.   

**Scholarship Analysis**
```{r}
smsreminder_number <- ggplot(dataset, aes(x=scholarship)) +
  geom_bar() +
  xlab("Scholarship") + 
  ylab("Count")

smsreminder_ratio <- ggplot(dataset, aes(x=scholarship, fill=show_up)) + 
  geom_bar(position="fill") + 
  xlab("Scholarship") + 
  ylab("Ratio") +
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))

grid.arrange(smsreminder_number, smsreminder_ratio, ncol=2, top="Scholarship")
```

**Time Analysis**

**Weather Analysis**
