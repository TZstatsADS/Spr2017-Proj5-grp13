---
title: "Project 5 - Predicting Facebook Check-Ins"
output: html_notebook
---

## Project Description

## Why did we choose this project?


## Data
The dataset ... too include(Brazil, state of Espirito Santo - Public Sector - Primary Care)
*Description of the dataset*
- Age: Age of the patient
- Gender: Gender of the patient
- AppointmentRegistration: Time and date when the patient took the appointment
- AppointmentData: Date of the appointment
- Diabetes: Is the patient affected by diabetes? (0/1)
- Alcoolism: is the patient alcoolic? (0/1)
- Hipertension: Is the patient affected by hypertension? (0/1)
- Handcap: 
- Smokes: Is the patient smoking? (0/1)
- Scholarship: Is the patient receiving a scholarship? Those scholarships are given by Bolsa Familia to low income families who accept to send their kids to school nd have them vaccinated.
- Tuberculosis: Is the patient affected by tuberculosis? (0/1)
- AwaitingTime: How many days the patient waited between the appointment registration and the date of the appointment
- Status: Did the patient show-up or not? (No-Show/Show-Up)
*Source*

## Exploratory Data Analysis

**Step 0: Load Packages**

```{r, warning=FALSE}
library(dplyr)
library(plyr)
library(ggplot2)
library(gridExtra)
library(tidyr)
```

**Step 1: Load Dataset**
```{r}
dataset <- read.csv("../data/No-show-Issue-Comma-300k.csv")
```

**Step 2: Clean & Organize dataset**
```{r}
# Check Format
str(dataset)
```

```{r}
# Update Columns Names
colnames(dataset) <- c("age", "gender", "appointment_registration", 
                       "appointment_date", "dayofweek_apptmt", "show_up",
                       "diabetes", "alcoholism", "hypertension", "handicap", 
                       "smoker", "scholarship", "tuberculosis",
                       "sms_reminder", "daydiff_regist_appt")

# Update Columns Format
dataset$sms_reminder <- factor(dataset$sms_reminder)
dataset$diabetes <- factor(dataset$diabetes)
dataset$alcoholism <- factor(dataset$alcoholism)
dataset$hypertension <- factor(dataset$hypertension)
dataset$handicap <- factor(dataset$handicap)
dataset$smoker <- factor(dataset$smoker)
dataset$scholarship <- factor(dataset$scholarship)
dataset$tuberculosis <- factor(dataset$tuberculosis)
```

```{r}
# Check Values
summary(dataset)
```


```{r}
# Data Cleaning

# Age: The Age shouldn't be negative, we will remove those rows. 
dataset <- dataset[dataset$age>0,]

# Appointment day of the week: We don't know if this variable is linked to the registration date or the apointment date - we will delete it and use the raw columns only
dataset$dayofweek_apptmt <- NULL

# Number of days between registration time and appointment date: We will convert this value to be positive
dataset$daydiff_regist_appt <- -(dataset$daydiff_regist_appt)

# Show-up / No-Show: 
dataset$show_up <- revalue(dataset$show_up, c("No-Show"=0, "Show-Up"=1))

# clean dates and time:
## Appt Registration Date
dataset$appointment_registration <- as.POSIXct(as.character(dataset$appointment_registration), 
                                               "%Y-%m-%d T%H:%M:%SZ", 
                                               tz ="Brazil/East")

dataset$weekday_registration <- as.factor(format(dataset$appointment_registration, "%a"))
dataset$day_registration <- as.numeric(as.integer(format(dataset$appointment_registration, 
                                                         "%d")))
dataset$month_registration <- as.numeric(format(dataset$appointment_registration, "%m"))
dataset$hour_registration <- as.numeric(format(dataset$appointment_registration,"%H"))
dataset$minute_registration <- as.numeric(format(dataset$appointment_registration,"%M"))
dataset$day_of_year_registration <- as.numeric(format(dataset$appointment_registration,"%j"))
dataset$week_of_year_registration <- as.numeric(format(dataset$appointment_registration,"%U"))
dataset$am_pm_registration <- as.factor(format(dataset$appointment_registration,"%p"))

#Appt Actual Date
dataset$appointment_date <- as.POSIXct(as.character(dataset$appointment_date), 
                                       "%Y-%m-%d T%H:%M:%SZ", 
                                       tz = "Brazil/East")

dataset$weekday_appointment <- as.factor(format(dataset$appointment_date,"%a"))
dataset$day_appointment <- as.numeric(as.integer(format(dataset$appointment_date,"%d")))
dataset$month_appointment <- as.numeric(format(dataset$appointment_date,"%m"))
dataset$day_of_year_appointment <- as.numeric(format(dataset$appointment_date,"%j"))
dataset$week_of_year_appointment <- as.numeric(format(dataset$appointment_date,"%U"))
```


**Step 3: First Exploration**
```{r}
# Number of rows
nb_rows <- nrow(dataset)
```

Prediction Variable: Let's first analyse the prediction variabla alone
```{r}
ggplot(dataset, aes(x = show_up, fill=show_up)) +
  geom_bar() +
  ggtitle("Number of Patients Showing Up") +
  ylab("Count") +
  xlab("Show-up") + 
  scale_fill_discrete("Show-up", labels=c("No", "Yes"))
```
The proportion of people not showing up is very high.   
From a data science point of view, we still have unbalanced classes, we will have to deal with it when doing predictions.  

Which Dates have we access to? 

We have access to two years of data. 2/01/2014 to 30/12/2015
Do we have the same number of data per week? 


```{r}
dataset %>% 
  group_by(appointment_date) %>% 
  summarise(total_noshow=sum(show_up==0)/n()) %>% 
  ggplot(aes(x=appointment_date, y=total_noshow)) + 
    geom_point(alpha=0.3) +
    xlab("Appointment Date") +
    ylab("Percentage of No Show Per Day") +
    ggtitle("Percentage of No Show Depending on the Date")
```

 
There is no strong seasonality 

Number of appoitnments per week
```{r}
dataset$year_appointment <- as.numeric(format(dataset$appointment_date,"%Y"))

dataset %>% 
  group_by(week_of_year_appointment, year_appointment) %>% 
  summarise(patients=n()) %>% 
  ggplot(aes(x=week_of_year_appointment, y=patients)) + 
    geom_point(alpha=0.3) +
    facet_grid(year_appointment ~ .) +
    xlab("Week of the Year") +
    ylab("Number of Appointments") +
    ggtitle("Number of Appointments per Aeek")
```

SAme kind of seasonality for bothe years 
Seems to have the same number of appointments per week.

Hour Registration

```{r}

dataset %>% 
  group_by(hour_registration) %>% 
  summarise(show_up=sum(show_up==0),
            no_show=sum(show_up==1)) %>% 
  melt(id="hour_registration") %>%
  ggplot(aes(x=hour_registration, y=value, colour=variable)) + 
    geom_point(alpha=0.3) +
    xlab("Week of the Year") +
    ylab("Number of Appointments") +
    ggtitle("Number of Appointments per Week")
```

```{r}
ggplot(dataset, aes(x=hour_registration, fill=show_up)) + 
  geom_density() + 
  facet_grid(.~show_up)
```

Day Appointment
```{r}
ggplot(dataset, aes(x=weekday_appointment, fill=show_up)) + 
  geom_density() + 
  facet_grid(.~show_up)
```

```{r}
ggplot(dataset, aes(x=weekday_appointment, fill=show_up)) + 
  geom_density() + 
  facet_grid(gender~show_up)
```

```{r}
dataset %>% 
  group_by(weekday_registration) %>% 
  summarise(noshow_prop=sum(show_up==0)/n()) %>% 
  ggplot(aes(x=weekday_registration, y=noshow_prop, fill=weekday_registration)) + 
        geom_bar(stat="identity") + 
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Gender Analysis
```{r}
ggplot(dataset, aes(x=hour_registration, fill=show_up)) + 
  geom_density() + 
  facet_grid(gender~show_up)
```

Age

```{r}
dataset %>% 
  group_by(age) %>% 
  summarise(nb_perage=n()) %>% 
  ggplot(aes(x=age, y=nb_perage)) + 
    geom_point(alpha=0.3) +
    xlab("Age") +
    ylab("Number of Patients") +
    ggtitle("Number of Patients depending on the Age")
```

```{r}
ggplot(dataset, aes(x=show_up, y=age, fill=show_up)) + 
  geom_boxplot()
```

Health Conditions
```{r}
diabetes <- ggplot(dataset, aes(x=diabetes, fill=show_up)) + 
  geom_bar()
alcoholism <- ggplot(dataset, aes(x=alcoholism, fill=show_up)) + 
  geom_bar()
hypertension <- ggplot(dataset, aes(x=hypertension, fill=show_up)) + 
  geom_bar()
handicap <- ggplot(dataset, aes(x=handicap, fill=show_up)) + 
  geom_bar()
smoker <- ggplot(dataset, aes(x=smoker, fill=show_up)) + 
  geom_bar()
tuberculosis <- ggplot(dataset, aes(x=tuberculosis, fill=show_up)) + 
  geom_bar()

grid.arrange(diabetes, tuberculosis, hypertension, handicap, smoker,
             alcoholism, ncol=2, top='Health Conditions')
```

SMS Reminder
```{r}
ggplot(dataset, aes(x=sms_reminder, fill=show_up)) + 
  geom_bar(position="fill")
```

```{r}
ggplot(dataset, aes(x=weekday_appointment, fill=show_up)) + 
  geom_bar(position="fill")
```

